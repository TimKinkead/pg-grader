"use strict";try{var app=angular.module("app",["ui.router","ui.bootstrap","ngResource","ngSanitize","divResizer","angularResizable"]);app.config(["$locationProvider","$urlRouterProvider",function(a,b){a.html5Mode({enabled:!0,requireBase:!0}),b.otherwise("/")}]),window.ie9&&!window.location.hash&&window.location.pathname.length<=1&&(console.log("IE 9 requires # for client side routing."),window.location.assign("/#/"+window.location.search))}catch(e){console.log(e),window.location.assign("/unsupported")}angular.module("app").config(["$stateProvider",function(a){a.state("home",{url:"/",templateUrl:"modules/main/home/view.html",controller:"HomeController"}),a.state("welcome",{url:"/welcome",templateUrl:"modules/main/welcome/view.html",controller:"WelcomeController",data:{memberOnly:!0}}),a.state("user",{template:"<div ui-view></div>",controller:"UserController","abstract":!0}),a.state("user.signup",{url:"/sign-up",templateUrl:"modules/main/user/views/sign-up.html",data:{guestOnly:!0}}),a.state("user.login",{url:"/login",templateUrl:"modules/main/user/views/login.html",data:{guestOnly:!0}}),a.state("user.settings",{url:"/settings",templateUrl:"modules/main/user/views/settings.html",data:{memberOnly:!0}}),a.state("user.forgotpassword",{url:"/forgot-password",templateUrl:"modules/main/user/views/forgot-password.html",data:{guestOnly:!0}}),a.state("user.resetpassword",{url:"/reset-password",templateUrl:"modules/main/user/views/reset-password.html",data:{guestOnly:!0}}),a.state("user.adminsignup",{url:"/sign-up/admin",templateUrl:"modules/main/user/views/admin-sign-up.html",data:{guestOnly:!0}}),a.state("essays",{url:"/essays?all-essays-graded&modal-check&viewDetails&essay&essayFilterBy&moduleFilterBy",templateUrl:"modules/main/essays/view.html",controller:"EssaysController",data:{memberOnly:!0}}),a.state("grade",{url:"/grade?scoresheet&essay&masterScore",templateUrl:"modules/main/grade/view.html",controller:"GradeController",data:{memberOnly:!0}}),a.state("graders",{url:"/graders",templateUrl:"modules/main/graders/view.html",controller:"GradersController",data:{adminOrFacilitator:!0}}),a.state("download",{url:"/download",templateUrl:"modules/main/download/view.html",controller:"DownloadController"}),a.state("admin",{url:"/admin",templateUrl:"modules/main/admin/view.html",controller:"AdminController",data:{adminOnly:!0}}),a.state("upload",{url:"/upload",templateUrl:"modules/main/upload/view.html",controller:"UploadController",data:{adminOnly:!0}})}]),angular.module("app").config(["$httpProvider",function(a){a.defaults.headers["delete"]={"Content-Type":"application/json;charset=utf-8"},a.defaults.cache=!1,a.defaults.headers.get||(a.defaults.headers.get={}),a.defaults.headers.get["If-Modified-Since"]="0"}]),angular.module("app").run(["$rootScope","$state","CurrentUser",function(a,b,c){function d(){return Boolean(c.data&&c.data._id)}function e(){return Boolean(d()&&c.data.admin)}function f(){return Boolean(d()&&c.data.facilitator)}a.$on("$stateChangeStart",function(a,c,g,h,i){c.data&&c.data.guestOnly&&d()?(a.preventDefault(),b.go("home")):c.data&&c.data.memberOnly&&!d()?(a.preventDefault(),b.go("home")):c.data&&c.data.adminOrFacilitator&&!e()&&!f()?(a.preventDefault(),b.go("home")):c.data&&c.data.adminOnly&&!e()&&(a.preventDefault(),b.go("home"))})}]),angular.module("app").run(["$location",function(a){"_=_"===a.hash()&&a.url(a.path())}]),angular.module("app").service("CurrentUser",["$window",function(a){return{data:a.user||{}}}]),angular.module("divResizer",[]).directive("resizer",function(a){return function(b,c,d){function e(b){if("vertical"===d.resizer){var e=b.pageX;d.resizerMax&&e>d.resizerMax&&(e=parseInt(d.resizerMax)),c.css({left:e+"px"}),a.$attrs.resizerLeft.css({width:e+"px"})}else{var f=window.innerHeight-b.pageY;c.css({bottom:f+"px"})}}function f(){a.unbind("mousemove",e),a.unbind("mouseup",f)}c.on("mousedown",function(b){b.preventDefault(),a.on("mousemove",e),a.on("mouseup",f)})}}),angular.module("app").directive("fixedSizeFullHeight",["$window",function(a){return{restrict:"C",link:function(b,c,d){function e(){var b=c[0]?c[0]:c,d=b.parentNode.children,e=Array.prototype.indexOf.call(b.parentNode.children,b),f=d.length>1&&0!==e?b.parentNode.children[e-1]:document.getElementById("main-nav"),g=f.getBoundingClientRect().bottom;b.style.minHeight=Math.floor(a.innerHeight-g)+"px"}e(),angular.element(a).bind("resize",e),b.$on("$destroy",function(){angular.element(a).unbind("resize",e)})}}}]),angular.module("app").filter("averageScore",[function(){return function(a){if(!a)return null;var b,c=0,d=0;for(var e in a)a.hasOwnProperty(e)&&"number"==typeof a[e]&&(c+=a[e],d++);if(!c||!d)return null;if(b=Math.round(c/d*100)/100,b=b.toString(),b.indexOf(".")<0)b+=".00";else for(;b.length-(b.indexOf(".")+1)<2;)b+="0";return b}}]),angular.module("app").filter("capitalize",[function(){return function(a){if(!a)return"";if("string"!=typeof a)return a;for(var b="",c=!0,d=0,e=a.length;d<e;d++)/[^a-zA-Z0-9\/\&]/.test(a[d])?(b+=" ",c=!0):(b+=c?a[d].toUpperCase():a[d].toLowerCase(),c=!1);var f=["BPA","UN"];if(f.indexOf(b)>-1)return b.toUpperCase();f.forEach(function(a){var c=new RegExp("(^"+a+"\\s|\\s"+a+"\\s|\\s"+a+"$)","i");b.match(c)&&(b=b.replace(c," *"+a+"* "))});for(var g=/(\s\s|\*)/;b.match(g);)b=b.replace(g," ");return b=b.trim()}}]),angular.module("app").filter("percentage",[function(){return function(a){return a||0===a?(a=Number(a),Math.round(100*a)+"%"):""}}]),angular.module("app").filter("roughNumber",[function(){return function(a){var b=a;return b>=1e3&&b<1e4?(b=Math.round(b/100)/10,b+="k"):b>=1e4&&b<1e6?(b=Math.round(b/1e3),b+="k"):b>=1e6&&b<1e7?(b=Math.round(b/1e5)/10,b+="M"):b>=1e7&&(b=Math.round(b/1e6),b+="M"),b}}]),angular.module("app").controller("NavbarController",["$scope","$window","CurrentUser",function(a,b,c){a.user=c.data,a.window=b,a.toggleNavbar=function(){angular.element(document.getElementById("navbar-collapse")).toggleClass("in")},a.logout=function(a){a&&a.preventDefault(),window.location.assign("/data/user/logout")}}]),angular.module("app").directive("navbar",[function(){return{restrict:"A",templateUrl:"modules/parts/navbar/view.html",scope:{},controller:"NavbarController"}}]),angular.module("app").controller("AdminController",["$scope","$resource","$http","$window","CurrentUser",function(a,b,c,d,e){var f=a.user=e.data,g=a.status={errorMessages:[],successMessages:[]},h=a.data={},i=a.collections=["error","essay","group","module","rubric","scoresheet","user"];a.initCollections=["rubric","module","group"];i.forEach(function(a){h[a]={}}),a.closeErrorMessage=function(a){g.errorMessages.splice(a,1)},a.closeSuccessMessage=function(a){g.successMessages.splice(a,1)};var j=a.count=function(a){g["counting"+a]=!0,c.get("/data/"+a+"/count",{}).success(function(b){g["counting"+a]=!1,h[a].count=Number(b)}).error(function(b){g["counting"+a]=!1,g.errorMessages.push("Error counting "+a+" docs!")})};i.forEach(function(a){j(a)});a.initialize=function(a){if(d.location.host.indexOf("localhost")<0&&h[a].count&&!f.admin)return void g.errorMessages.push("You don't have permission to initialize the "+a+" collection.");g["initializing"+a]=!0;var b="essay"===a?5e3:1e3;c.get("/data/"+a+"/init",{}).success(function(){g.successMessages.push("Initializing "+a+" collection."),setTimeout(function(){g["initializing"+a]=!1,j(a)},b)}).error(function(b){g["initializing"+a]=!1,g.errorMessages.push("Error initializing "+a+" collection!")})}}]),angular.module("app").controller("ConsensusScoresController",["$scope","$resource","$http","$timeout","$uibModal","$state","CurrentUser",function(a,b,c,d,e,f,g){var h=a.status={},i=(a.params={},a.errorMessages=[]),j=a.successMessages=[];a.fields=["no","date","grader","essay","rubric","score","edit"];a.user=g.data,a.closeErrorMessage=function(a){i.splice(a,1)},a.closeSuccessMessage=function(a){j.splice(a,1)},h.processing=!0;var k=a.scoresheets=b("data/scoresheet/list-consensus").query({},function(){h.processing=!1},function(a){h.processing=!1,i.push(a&&a.message?a.message:"Error! We had trouble retrieving the consensus scores. Please try refreshing the page.")});a.viewDetails=function(a){var b=e.open({templateUrl:"modules/main/consensus-scores/modal/view.html",controller:"ConsensusScoresModalController",size:"xl",resolve:{scoresheets:function(){var b=[];return k.forEach(function(c){c.essay.id===a&&b.push(c)}),b}}});b.result.then(function(){console.log("close")},function(a){console.log("dismiss")})},a.$watch("params.param",function(a,b){a!==b&&console.log(a)})}]),angular.module("app").controller("ConsensusScoresModalController",["$scope","$uibModalInstance","scoresheets",function(a,b,c){a.scoresheets=c;var d=a.fields=["grader","rubric"];c.forEach(function(a){for(var b in a.score)a.score.hasOwnProperty(b)&&d.indexOf(b)<0&&d.push(b)}),a.cancel=function(){b.dismiss()}}]),angular.module("app").controller("DownloadController",["$scope","$window","$uibModal",function(a,b,c){function d(b){setTimeout(function(){e.successMessage=null,a.$digest()},b)}var e=a.status={};a.closeErrorMessage=function(){e.errorMessage=null},a.closeSuccessMessage=function(){e.successMessage=null},a.downloadGradedWorkCSV=function(){b.location.href="http://"+b.location.host+"/data/scoresheet/download",e.successMessage="Download in progress.",d(3e3)},a.downloadGradedWorkTSV=function(){b.location.href="http://"+b.location.host+"/data/scoresheet/download?delimiter=tab",e.successMessage="Download in progress.",d(3e3)},a.downloadGradedWorkSRI=function(){b.location.href="http://"+b.location.host+"/data/scoresheet/download/sri",e.successMessage="Download in progress.",d(5e3)}}]),angular.module("app").controller("EssaysController",["$scope","$rootScope","$resource","$http","$timeout","$uibModal","$state","$stateParams","$window","CurrentUser",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b={beingGradedBy:0,beingGradedByYou:!1,skippedBy:0,skippedByYou:!1,wasGradedBy:0,wasGradedByYou:!1,yourScoreSheet:null,masterScoreSheet:null,downloadLink:"https://drive.google.com/uc?id="+a.googleDriveId+"&export=download",openLink:"https://drive.google.com/file/d/"+a.googleDriveId+"/view"};if(a.graders&&a.graders.length){var c=!1;a.graders.forEach(function(a){b.beingGradedBy++,a.toString()===p._id.toString()&&(b.beingGradedByYou=!0,c=!0)}),q.resumeGrading=c}return a.skip&&a.skip.length&&a.skip.forEach(function(a){b.skippedBy++,a.user&&a.user.toString()===p._id.toString()&&(b.skippedByYou=!0)}),a.scoresheets&&a.scoresheets.length&&a.scoresheets.forEach(function(a){a.masterScore?b.masterScoreSheet=a:b.wasGradedBy++,a.user&&a.user.toString()===p._id.toString()&&(b.wasGradedByYou=!0,b.yourScoreSheet=a)}),b}function l(a){var b;switch(q.essayFilterBy){case"all essays":b=!0;break;case"master scores":b=Boolean(a.masterScore);break;case"graded essays":b=Boolean(a.wasGradedBy);break;case"ungraded essays":b=Boolean(!a.wasGradedBy);break;case"my essays":b=Boolean(a.beingGradedByYou||a.skippedByYou||a.wasGradedByYou);break;default:b=!0}return q.moduleFilterBy&&a.module._id!==q.moduleFilterBy&&(b=!1),b}function m(){q.processingEssays=!0,q.noVisibleEssays=!0,u.forEach(function(a){a.visible=l(a),a.visible&&(q.noVisibleEssays=!1)}),q.processingEssays=!1}function n(){var a=!1;["essayFilterBy","moduleFilterBy"].forEach(function(b){q[b]!==h[b]&&(h[b]=q[b],a=!0)}),(p.admin||p.facilitator)&&a&&g.go(g.$current,h,{notify:!1,reload:!1})}var o=document.getElementById("html-body");o.style.overflowY="scroll";var p=a.user=j.data,q=a.status={essayFilterBy:p.admin?"graded essays":"all essays",moduleFilterBy:null},r=(a.params={},a.errorMessages=[]),s=a.successMessages=[],t=(a.essayFilterOptions=p.admin?["master scores","graded essays","ungraded essays","all essays"]:p.facilitator?["all essays","my essays","master scores","graded essays","ungraded essays"]:["all essays","my essays"],a.essayStats={},i.location.host.indexOf("localhost")>-1?1e4:3e4),u=a.essays=[],v=a.modules=[];a.fields=p.admin?["no","id","module","being graded by","skipped by","graded by","master score","details"]:p.facilitator?["no","id","module","being graded by","skipped by","graded by","master score","grade","details"]:["no","id","module","in progress","skipped","graded","master score","grade"];a.closeErrorMessage=function(a){r.splice(a,1)},a.closeSuccessMessage=function(a){s.splice(a,1)};var w=function z(){console.log("refreshEssays"),"essays"===g.current.name&&d.get("data/essay/list",{}).success(function(a){var b={};a.forEach(function(a){b[a._id]=k(a)}),u.forEach(function(a){var c=b[a._id];c&&(a=angular.extend(a,c))}),setTimeout(z,t)}).error(function(a){console.log(a)})};q.processingEssays=!0,u=a.essays=c("data/essay/list").query({},function(){q.processingEssays=!1,u.forEach(function(a){a=angular.extend(a,k(a)),a.visible=l(a)}),(p.admin||p.facilitator)&&setTimeout(w,t)},function(a){q.processingEssays=!1,r.push(a&&a.message?a.message:"Error! We had trouble listing the essays. Please try refreshing the page.")}),q.processingModules=!0,v=a.modules=c("data/module/list").query({},function(){q.processingModules=!1,v[0]&&v[0]._id&&(q.moduleFilterBy=v[0]._id)},function(a){q.processingModules=!1});var x=a.viewDetails=function(a){var b=f.open({templateUrl:"modules/main/essays/modal-detail/view.html",controller:"EssayDetailModalController",size:"xl",resolve:{essayId:function(){return a}}});b.result.then(function(){console.log("close")},function(a){console.log("dismiss")})},y=a.checkMasterScore=function(a){var b=f.open({templateUrl:"modules/main/essays/modal-check/view.html",controller:"MasterScoreModalController",size:"xl",resolve:{essayId:function(){return a}}});b.result.then(function(){console.log("close")},function(a){console.log("dismiss")})};a.gradeButtonNgClass=function(a){var b={};return a.beingGradedByYou?b["btn-danger"]=!0:a.wasGradedByYou?b["btn-info"]=!0:a.skippedByYou?b["btn-default"]=!0:b["btn-success"]=!0,b},a.gradeButtonText=function(a){return a.beingGradedByYou&&a.wasGradedByYou?"finish editing":a.beingGradedByYou?"finish grading":a.wasGradedByYou?"edit score":"grade now"},h.essayFilterBy&&(q.essayFilterBy=h.essayFilterBy),h.moduleFilterBy&&(q.moduleFilterBy=h.moduleFilterBy),h["all-essays-graded"]&&(q.allEssaysGraded=!0,h["all-essays-graded"]=null,g.go(g.$current,h,{notify:!1,reload:!1})),h["modal-check"]&&(h.essay&&y(h.essay),h["modal-check"]=null,h.essay=null,g.go(g.$current,h,{notify:!1,reload:!1})),h.viewDetails&&(h.essay&&x(h.essay),h.viewDetails=null,h.essay=null,g.go(g.$current,h,{notify:!1,reload:!1})),a.$watch("status.essayFilterBy",function(a,b){a!==b&&(m(),n())}),a.$watch("status.moduleFilterBy",function(a,b){a!==b&&(m(),n())})}]),angular.module("app").controller("MasterScoreModalController",["$scope","$uibModalInstance","$resource","CurrentUser","essayId",function(a,b,c,d,e){var f=a.user=d.data,g=a.status={},h=a.essay=null,i=a.scoresheets=[],j=a.fields=["grader"];a.cancel=function(){b.dismiss()},h=a.essay=c("data/essay").get({essay:e,full:!0},function(){var a={};h.gradedBy.forEach(function(b){b&&b._id&&(a[b._id]=b)});var b=!1;h.scoresheets.forEach(function(c){if(f.admin||f.facilitator||c.masterScore||c.user.toString()===f._id.toString()){c.user=a[c.user],i.push(c),c.masterScore&&(b=!0);for(var d in c.score)c.score.hasOwnProperty(d)&&j.indexOf(d)<0&&j.push(d)}}),b||(g.noMasterScore=!0),j.push("avg score")},function(a){g.errorMessage="We had trouble loading the scores. Please try again."})}]),angular.module("app").controller("EssayDetailModalController",["$scope","$uibModalInstance","$resource","$state","CurrentUser","essayId",function(a,b,c,d,e,f){var g=a.user=e.data,h=a.status={},i=a.essay=null,j=a.scoresheets=[],k=a.fields=["grader"];a.cancel=function(){b.dismiss()},i=a.essay=c("data/essay").get({essay:f,full:!0},function(){var a={};i.gradedBy.forEach(function(b){b&&b._id&&(a[b._id]=b)});var b=!1;i.scoresheets.forEach(function(c){if(g.admin||g.facilitator||c.masterScore||c.user.toString()===g._id.toString()){c.user=a[c.user],j.push(c),c.masterScore&&(b=!0);for(var d in c.score)c.score.hasOwnProperty(d)&&k.indexOf(d)<0&&k.push(d)}}),i.masterScore&&!b&&(h.noMasterScore=!0),k.push("avg score"),g.admin&&k.push("edit")},function(a){h.errorMessage="We had trouble loading the scores. Please try again."}),a.adminAddGrade=function(a){b.dismiss(),d.go("grade",{essay:a._id})},a.adminEditGrade=function(a){b.dismiss(),d.go("grade",{scoresheet:a._id,masterScore:a.masterScore})}}]),angular.module("app").controller("GradeController",["$scope","$resource","$http","$uibModal","$window","$state","$stateParams","$sce","CurrentUser",function(a,b,c,d,e,f,g,h,i){function j(a){a.returnValue=A}function k(){e.addEventListener?e.addEventListener("beforeunload",j):e.attachEvent("onbeforeunload",j)}function l(){e.removeEventListener?e.removeEventListener("beforeunload",j):e.detachEvent("onbeforeunload",j)}function m(){if(y.rubric){var a,b;if("show all"===v.rubricElements)for(a=0,b=y.rubric.fields.length;a<b;a++)y.rubric.fields[a].visible=!0;else{var c=!1;for(a=0,b=y.rubric.fields.length;a<b;a++)c||x.score[y.rubric.fields[a].name]||0!==a&&!x.score[y.rubric.fields[a-1].name]?y.rubric.fields[a].visible=!1:(y.rubric.fields[a].visible=!0,c=!0)}}}function n(){[w,x,y].forEach(function(a){for(var b in a)a.hasOwnProperty(b)&&(a===y&&"rubrics"===b?y.rubrics=y.rubrics||null:a===x&&"score"===b?x.score={}:a[b]=null)}),g.scoresheet=null,g.essay=null,l()}function o(){w.processingEssay=!0,c.get("/data/essay?essay="+x.essay+"&grading=true").success(function(b){setTimeout(function(){w.processingEssay=!1,a.$digest()},1e3),w.masterScore=b.masterScore,y.essay=b,y.essay.iframeLink=h.trustAsResourceUrl("https://docs.google.com/gview?url=https://drive.google.com/uc?id="+b.googleDriveId+"&embedded=true"),y.essay.downloadLink="https://drive.google.com/uc?id="+b.googleDriveId+"&export=download",y.essay.openLink="https://drive.google.com/file/d/"+b.googleDriveId+"/view",x.rubric||(x.rubric=b.module.rubric),x.scoresheet||!b.scoresheets||v.admin||b.scoresheets.forEach(function(a){a.user&&a.user.toString()===v._id.toString()&&!a.masterScore&&(x.scoresheet=a._id)})}).error(function(a){w.processingEssay=!1,z("We had trouble loading the essay. Please try again.")})}function p(){n(),w.processingEssay=!0,c.get("/data/essay/next").success(function(a){if("all essays graded"===a.message){var b=d.open({templateUrl:"modules/main/grade/modal/done.html",controller:"GradeModalController",backdrop:"static"});return void b.result.then(function(){f.go("essays",{"all-essays-graded":!0})},function(){f.go("essays",{"all-essays-graded":!0})})}w.newModule=a.newModule,w.masterScore=a.masterScore,w.consensusScore=a.consensusScore,x.essay=a._id}).error(function(a){w.processingEssay=!1,z("We had trouble loading the essay. Please try again.")})}function q(){if(y.rubrics)for(var a=0,b=y.rubrics.length;a<b;a++)if(x.rubric===y.rubrics[a]._id){y.rubric=y.rubrics[a],y.rubric.fields.forEach(function(a){a.details.forEach(function(a){a.texts=a.text?a.text.split("\n"):null})}),m();break}}function r(){w.processingRubrics=!0,y.rubrics=b("/data/rubric/list").query({},function(){w.processingRubrics=!1,x.rubric&&q()},function(a){w.processingRubrics=!1,z("We had trouble getting the list of rubrics. Please close the modal and try again.")})}function s(){w.processingScoreSheet=!0,c.get("/data/scoresheet?scoresheet="+x.scoresheet).success(function(a){w.processingScoreSheet=!1,w.saved=!0,w.formValid=!0,y.scoresheet=a,x.user=v.admin&&a.user._id?a.user._id:x.user,x.essay=a.essay._id,x.rubric=a.rubric._id,x.score=a.score,l()}).error(function(a){w.processingScoreSheet=!1,z("We had trouble loading your score sheet. Please try again.")})}function t(){var a=!1;["scoresheet","essay","masterScore"].forEach(function(b){x[b]!==g[b]&&(g[b]=x[b],a=!0)}),a&&(g.scoresheet&&(g.essay=null),f.go(f.$current,g,{notify:!1,reload:!1}))}var u=document.getElementById("html-body");u.style.overflowY="hidden";var v=a.user=i.data,w=a.status={nextEssay:null,hidePrompt:null,saved:null,newModule:null},x=a.params={scoresheet:null,user:v._id,essay:null,rubric:null,score:{},masterScore:null},y=a.docs={scoresheet:null,essay:null,rubric:null,rubrics:null,graders:null};g.scoresheet?x.scoresheet=g.scoresheet:g.essay?x.essay=g.essay:w.nextEssay=!0,g.masterScore&&(x.scoresheet||x.essay)&&(x.masterScore=!0);var z=a.errorModal=function(a,b){a&&!b&&(b=a,a=null),a||(a="Error!"),b||(b="Something went wrong. Please try again.");var c=d.open({templateUrl:"modules/main/grade/modal/error.html",controller:"GradeModalErrorController",resolve:{info:function(){return{header:a,message:b}}}});c.result.then(function(){console.log("close")},function(){console.log("dismiss")})},A="Warning!\n\nYour work has not been saved.\nAre you sure you want to leave this page?\n";a.$on("$stateChangeStart",function(a,b,c,d,e){w.saved!==!1||w.skip||confirm(A)||a.preventDefault()}),a.$on("$destroy",function(a){l()}),a.switchSides=function(){v.rubricSide="right"===v.rubricSide?"left":"right",c.put("/data/user/settings",{rubricSide:v.rubricSide}).success(function(){console.log("rubricSide updated")}).error(function(a){console.log("error updating rubricSide")})},a.switchRubricElements=function(a){v.rubricElements=a,m(),c.put("/data/user/settings",{rubricElements:v.rubricElements}).success(function(){console.log("rubricElements updated")}).error(function(a){console.log("error updating rubricElements")})},a.switchPrompt=function(){w.hidePrompt=!w.hidePrompt};var B=a.updateRubricTableWidth=function(){w.rubricTableWidth=document.getElementById("rubric-table").clientWidth},C=a.updateIframeHeight=function(){console.log("updateIframeHeight");var a=document.getElementById("grade-dashboard"),b=document.getElementById("iframe-text");if(a&&b){var c=a.getBoundingClientRect().bottom-b.getBoundingClientRect().top;b.style.minHeight=c+"px",b.style.maxHeight=c+"px"}},D=a.updateIframeHeightDelay=function(a){setTimeout(C,a)};a.$on("angular-resizable.resizeEnd",function(a,b){B(),C()}),angular.element(e).bind("resize",function(){B(),C()}),a.nextEssay=function(){w.nextEssay=!0},a.skip=function(){var a=d.open({templateUrl:"modules/main/grade/modal/skip.html",controller:"GradeModalController",backdrop:"static"});a.result.then(function(a){w.processingSkip=!0,l(),c.put("/data/essay/skip",{essay:x.essay,reason:a}).success(function(){w.processingSkip=!1,w.skip=!0,f.go("essays")}).error(function(a){w.processingSkip=!1,f.go("essays")})},function(a){console.log(a||"dismiss")})},r(),a.scoreField=function(a,b,c){x.score[b]=c,m(),k(),w.saved=!1;a:{for(var d=0,e=y.rubric.fields.length;d<e;d++)if(!x.score[y.rubric.fields[d].name]){w.formValid=!1;break a}w.formValid=!0}},a.editField=function(a){for(var b=0,c=y.rubric.fields.length;b<c;b++)y.rubric.fields[b].visible=b===a},a.clickSave=function(){if(w.formValid)return!0;w.clickSave=!0;var a=d.open({templateUrl:"modules/main/grade/modal/invalid.html",controller:"GradeModalController"});return a.result.then(function(){console.log("close")},function(){console.log("dismiss")}),!1},a.save=function(){w.processingSave=!0,c.post("/data/scoresheet",x).success(function(a){if(w.processingSave=!1,w.saved=!0,l(),x.masterScore)return void f.go("essays",{essayFilterBy:"master scores",moduleFilterBy:y.essay.module._id});if(v.admin)return void f.go("essays",{essayFilterBy:"graded essays",moduleFilterBy:y.essay.module._id,essay:x.essay,viewDetails:!0});v.scoresheets++;var b;return w.masterScore?(b=d.open({templateUrl:"modules/main/grade/modal/check.html",controller:"GradeModalController",backdrop:"static"}),void b.result.then(function(b){v.checkScores++,b?"check-scores"===b?f.go("essays",{"modal-check":!0,essay:a.essay}):f.go(b):w.nextEssay=!0},function(){v.checkScores++,x.scoresheet=a._id})):(b=d.open({templateUrl:"modules/main/grade/modal/next.html",controller:"GradeModalController",backdrop:"static"}),void b.result.then(function(a){return a?void f.go(a):void(w.nextEssay=!0)},function(){x.scoresheet=a._id}))}).error(function(a){w.processingSave=!1,z("We had trouble saving your score sheet. Please try again.")})},v.admin&&(w.processingGraders=!0,y.graders=b("data/grader/list").query({},function(){w.processingGraders=!1},function(a){w.processingGraders=!1,z("We had trouble listing the graders.")})),a.$watch("status.nextEssay",function(a,b){!a||a===b&&y.essay||p()}),a.$watch("status.hidePrompt",function(a,b){a!==b&&D(100)}),a.$watch("params.scoresheet",function(a,b){!a||a===b&&y.scoresheet||(t(),s())}),a.$watch("params.essay",function(a,b){!a||a===b&&y.essay||(t(),o())}),a.$watch("params.rubric",function(a,b){a&&a!==b&&(b&&(w.saved=!1,k()),y.rubrics?q():r())}),a.initializeGradeDashboard=function(){console.log("init")}}]),angular.module("app").controller("GradeModalErrorController",["$scope","$uibModalInstance","info",function(a,b,c){a=angular.extend(a,c),a.cancel=function(){b.dismiss()}}]),angular.module("app").controller("GradeModalController",["$scope","$uibModalInstance",function(a,b){var c=a.status={},d=a.params={};a.cancel=function(){b.dismiss()},a.nextEssay=function(){b.close()},a.backToEssays=function(){b.close("essays")},a.clickSkip=function(){return c.clicked=!0,!0},a.skip=function(){b.close(d.reason)},a.reviewMasterScores=function(){b.close("check-scores")},a.reviewConsensusScores=function(){b.close("consensus-scores")}}]),angular.module("app").controller("GradedWorkController",["$scope","$resource","$http","$timeout","$uibModal","$state","CurrentUser",function(a,b,c,d,e,f,g){var h=a.status={},i=(a.params={},a.errorMessages=[]),j=a.successMessages=[],k=(a.fields=["no","date","grader","essay","rubric","score"],a.user=g.data);a.closeErrorMessage=function(a){i.splice(a,1)},a.closeSuccessMessage=function(a){j.splice(a,1)},h.processing=!0;var l=a.scoresheets=b("data/scoresheet/list").query({},function(){h.processingTopics=!1},function(a){h.processingTopics=!1,i.push(a&&a.message?a.message:"Error! We had trouble listing the graded work. Please try refreshing the page.")});a.newScoreSheet=function(){var a=e.open({templateUrl:"modules/main/graded-work/create/view.html",controller:"GradedWorkCreateController",backdrop:"static",size:"xl"});a.result.then(function(a){l.push(a)},function(a){console.log(a||"dismiss")})},a.editOrView=function(a){if(a.user._id===k._id)f.go("grade",{scoresheet:a._id});else{var b=e.open({templateUrl:"modules/main/graded-work/preview/view.html",controller:"GradedWorkPreviewController",size:"xl",resolve:{scoresheet:function(){return a}}});b.result.then(function(){console.log("close")},function(){console.log("dismiss")})}},a.editScoreSheet=function(a,b){var c=e.open({templateUrl:"modules/main/graded-work/edit/view.html",controller:"GradedWorkEditController",backdrop:"static",size:"xl",resolve:{scoresheet:function(){return a}}});c.result.then(function(a){l[b]=a},function(a){console.log(a||"dismiss")})},a.skippedEssays=b("data/essay/list-skipped").query(),a.$watch("params.param",function(a,b){a!==b&&console.log(a)})}]),angular.module("app").controller("GradedWorkCreateController",["$scope","$uibModalInstance","$http","$resource","CurrentUser",function(a,b,c,d,e){var f=a.user=e.data,g=a.status={},h=a.params={grader:null,studentWorkId:null,rubric:null,score:{}},i=a.rubric=null,j=a.rubrics=[];a.cancel=function(){b.dismiss("cancel")},a.closeErrorMessage=function(){g.errorMessage=null},f.admin?(g.processingGraders=!0,a.graders=d("/data/user/list").query({namesOnly:!0},function(){g.processingGraders=!1},function(a){g.processingGraders=!1,g.errorMessage=a&&a.message?a.message:"We had trouble listing the graders. Please close the modal and try again."})):h.grader=f._id,g.processingRubrics=!0,j=a.rubrics=d("/data/rubric/list").query({},function(){g.processingRubrics=!1},function(a){g.processingRubrics=!1,g.errorMessage=a&&a.message?a.message:"We had trouble getting the list of rubrics. Please close the modal and try again."}),a.getRubric=function(){return g.errorMessage=null,h.studentWorkId?void(g.getRubric=!0):void(g.errorMessage="Please enter a student work id.")},a.scoreField=function(a,b,c){i.fields[a+1]&&!h.score[i.fields[a+1].name]&&(i.fields[a+1].visible=!0),h.score[b]=c,i.fields[a].visible=!1,g.clicked=!1;a:{for(var d=0,e=i.fields.length;d<e;d++)if(!h.score[i.fields[d].name]){g.formValid=!1;break a}g.formValid=!0}},a.editField=function(a){i.fields[a].visible=!0},a.click=function(){return g.clicked=!0,!0},a.save=function(){g.formValid&&(g.processing=!0,console.log(JSON.stringify(h,null,4)),c.post("data/scoresheet",h).success(function(a){g.processing=!1,a.user=f,a.rubric=i,b.close(a)}).error(function(a){g.processing=!1,g.errorMessage=a&&a.message?a.message:"We had trouble saving your score sheet. Please try again."}))},a.$watch("params.rubric",function(b,c){if(b!==c)for(var d=0,e=j.length;d<e;d++)if(b===j[d]._id){i=a.rubric=j[d],i.fields[0].visible=!0;break}})}]),angular.module("app").controller("GradedWorkEditController",["$scope","$uibModalInstance","$http","$resource","CurrentUser","scoresheet",function(a,b,c,d,e,f){var g=a.user=e.data,h=a.status={},i=a.params=f,j=a.rubric=null,k=a.rubrics=[];a.cancel=function(){b.dismiss("cancel")},a.closeErrorMessage=function(){h.errorMessage=null},g.admin?(h.processingGraders=!0,a.graders=d("/data/user/list").query({namesOnly:!0},function(){h.processingGraders=!1},function(a){h.processingGraders=!1,h.errorMessage=a&&a.message?a.message:"We had trouble listing the graders. Please close the modal and try again."})):i.grader=g._id,h.processingRubrics=!0,k=a.rubrics=d("/data/rubric/list").query({},function(){h.processingRubrics=!1;for(var b=0,c=k.length;b<c;b++)if(k[b]._id.toString()===f.rubric._id.toString()){j=a.rubric=k[b];break}},function(a){h.processingRubrics=!1,h.errorMessage=a&&a.message?a.message:"We had trouble getting the list of rubrics. Please close the modal and try again."}),a.showAll=function(){h.showAll=!0;for(var a=0,b=j.fields.length;a<b;a++)j.fields[a].visible=!0},a.hideAll=function(){h.showAll=!1;for(var a=0,b=j.fields.length;a<b;a++)j.fields[a].visible=!1},a.scoreField=function(a,b,c){i.score[b]=c,j.fields[a].visible=!1,h.clicked=!1;a:{for(var d=0,e=j.fields.length;d<e;d++)if(!i.score[j.fields[d].name]){h.formValid=!1;break a}h.formValid=!0}},a.editField=function(a){j.fields[a].visible=!0},a.click=function(){return h.clicked=!0,!0},a.save=function(){h.formValid&&(h.processing=!0,console.log(JSON.stringify(i,null,4)),i.scoresheet=i._id,delete i._id,c.put("data/scoresheet",i).success(function(a){h.processing=!1,a.user=g,a.rubric=j,b.close(a)}).error(function(a){h.processing=!1,h.errorMessage=a&&a.message?a.message:"We had trouble saving your score sheet. Please try again."}))},a.$watch("params.rubric",function(b,c){if(b!==c)for(var d=0,e=k.length;d<e;d++)if(b._id===k[d]._id){j=a.rubric=k[d];break}})}]),angular.module("app").controller("GradedWorkPreviewController",["$scope","$uibModalInstance","scoresheet",function(a,b,c){a.scoresheet=c;var d=a.fields=[];for(var e in c.score)c.score.hasOwnProperty(e)&&d.indexOf(e)<0&&d.push(e);a.cancel=function(){b.dismiss()}}]),angular.module("app").controller("GradersController",["$scope","$resource","$http","$timeout","$uibModal","CurrentUser",function(a,b,c,d,e,f){var g=a.user=f.data,h=a.status={},i=(a.params={},a.errorMessages=[]),j=a.successMessages=[],k=a.graders=[],l=a.modules=[],m=a.modulesMap={};a.fields=g.admin?["no","id","name","email","group","graded essays","check scores","facilitator","admin"]:["no","id","name","email","graded essays","check scores","facilitator"];a.closeErrorMessage=function(a){i.splice(a,1)},a.closeSuccessMessage=function(a){j.splice(a,1)},h.processingModules=!0,l=a.graders=b("data/module/list").query({},function(){h.processingModules=!1,l.forEach(function(a){a&&a._id&&(m[a._id]=a)})},function(a){h.processingModules=!1}),a.getGroupTooltip=function(a){var b="";if(a&&(a.subject&&(b+=a.subject),a.modules&&a.modules.length)){var c=[];a.modules.forEach(function(a){m[a]&&m[a].name&&c.push(m[a].name)}),c.length&&(b+="<br>("+c.join(", ")+")")}return b},h.processing=!0,k=a.graders=b("data/grader/list").query({},function(){h.processing=!1;
},function(a){h.processing=!1,i.push(a&&a.message?a.message:"Error! Could not list graders. Please try refreshing the page.")}),a.newGrader=function(a){var b=e.open({templateUrl:"modules/main/graders/create/view.html",controller:"GradersCreateController",backdrop:"static"});b.result.then(function(a){k.push(a)},function(a){console.log(a||"dismiss")})},a.editGrader=function(a){console.log("edit grader")}}]),angular.module("app").controller("GradersCreateController",["$scope","$uibModalInstance","$http","$resource",function(a,b,c,d){var e=a.status={},f=a.params={};a.emailRegex=/.*\@.*\..*/;a.cancel=function(){b.dismiss("cancel")},a.closeErrorMessage=function(){e.errorMessage=null},a.click=function(){return e.clicked=!0,!0},a.save=function(){e.clicked=!0,e.processing=!0,c.post("data/grader",f).success(function(a){e.processing=!1,b.close(a)}).error(function(a){e.processing=!1,e.errorMessage=a&&a.message?a.message:"We had trouble registering you. Please try again."})}}]),angular.module("app").controller("HomeController",["$scope","CurrentUser",function(a,b){a.user=b.data}]),angular.module("app").controller("UploadController",["$scope","$rootScope","$resource","$http","$timeout","$uibModal","$state","$stateParams","$window","CurrentUser",function(a,b,c,d,e,f,g,h,i,j){function k(a,b){n["processingFolderId"+a._id]=!0,d.put("data/module",{_id:a._id,googleDriveFolderId:b}).success(function(){a.googleDriveFolderId=b,n["processingFolderId"+a._id]=!1}).error(function(b){console.log(b),n["processingFolderId"+a._id]=!1})}function l(a,b){d.get("data/essay/count?module="+a).success(function(c){if(r[a]=c,b)return b()}).error(function(a){console.log(a)})}function m(){for(var a=0;a<q.length;a++)l(q[a]._id)}var n=(a.user=j.data,a.status={}),o=(a.params={},a.errorMessages=[]),p=a.successMessages=[],q=a.modules=[],r=a.essayQtyByModuleId={};a.tableFields=["no","module name","google drive folder id","number of essays","sync"];a.closeErrorMessage=function(a){o.splice(a,1)},a.closeSuccessMessage=function(a){p.splice(a,1)},a.connectGoogleDrive=function(){window.location.assign("/data/user/google-drive/connect")},a.listGoogleDriveFiles=function(){c("/data/user/google-drive/files").query({},function(a){},function(a){})},a.selectFolder=function(a){if(a){var b=f.open({templateUrl:"modules/main/upload/modal-select-folder/view.html",controller:"UploadSelectFolderModalController",size:"lg",resolve:{module:function(){return a}}});b.result.then(function(b){console.log("close"),k(a,b)},function(a){console.log("dismiss")})}},n.processingModules=!0,q=a.modules=c("data/module/list").query({},function(){n.processingModules=!1,m()},function(a){n.processingModules=!1}),a.syncEssays=function(a){n["syncingEssays"+a._id]=!0,d.get("data/essay/sync",{params:{module:a._id}}).success(function(){l(a._id,function(){n["syncingEssays"+a._id]=!1,console.log(r)})}).error(function(b){console.log(b),"!files || !files.length"===b&&o.push("No files found! Please check the folder id and/or refresh your token, then try again."),n["syncingEssays"+a._id]=!1})}}]),angular.module("app").controller("UploadSelectFolderModalController",["$scope","$uibModalInstance","$resource","$state","CurrentUser","module",function(a,b,c,d,e,f){var g=(a.user=e.data,a.module=f,a.status={},a.params={});a.cancel=function(){b.dismiss()},a.save=function(){g.googleDriveFolderId&&b.close(g.googleDriveFolderId)}}]),angular.module("app").controller("UserController",["$scope","$http","$resource","$state","$location","$window","CurrentUser",function(a,b,c,d,e,f,g){var h=a.user={},i=(a.window=f,a.status={}),j=a.params={},k=a.groups=[];a.emailRegex=/.*\@.*\..*/,a.passwordRegex=/.{6}/;if(a.$on("$stateChangeStart",function(a,b,c,d,e){[i].forEach(function(a){for(var b in a)a.hasOwnProperty(b)&&delete a[b]}),h.password=null}),a.closeErrorMessage=function(){i.errorMessage=null},a.closeSuccessMessage=function(){i.successMessage=null},a.goToSignUp=function(){i.errorMessage=null,i.clicked=!1,d.go("user.signup")},a.toggleFacilitator=function(){h.facilitator=!h.facilitator},a.toggleShowPassword=function(){i.showPassword=!i.showPassword},i.processingGroups=!0,k=a.groups=c("data/group/list").query({},function(){i.processingGroups=!1},function(a){i.processingGroups=!1,i.errorMessage=a&&a.message?a.message:"We had trouble listing the groups. Please try refreshing the page."}),a.selectGroup=function(a){h.group=a;var b=[];a.modules&&a.modules.forEach(function(a){a._id&&b.push(a._id)}),h.group.modules=b,i.showGroups=!1},a.click=function(){return i.clicked=!0,!0},a.signUp=function(a){a&&(h.admin=!0),i.errorMessage=null,i.processing=!0,b.post("/data/user/sign-up",h).success(function(a){i.processing=!1,g.data=angular.extend(g.data,a),d.go(h.admin?"essays":"welcome")}).error(function(a){i.processing=!1,i.errorMessage=a&&a.message?a.message:"We had trouble signing you up. Please try again."})},a.goToLogin=function(){i.errorMessage=null,i.clicked=!1,d.go("user.login")},a.login=function(){i.errorMessage=null,i.processing=!0,b.post("/data/user/login",h).success(function(a){i.processing=!1,g.data=angular.extend(g.data,a),d.go(a.admin?"essays":"welcome")}).error(function(a){i.processing=!1,i.errorMessage=a&&a.message?a.message:"We had trouble logging you in. Please try again."})},a.goToForgotPassword=function(){i.errorMessage=null,i.clicked=!1,d.go("user.forgotpassword")},a.sendPasswordResetLink=function(){i.successMessage=null,i.errorMessage=null,i.processing=!0,b.post("/data/user/forgot-password",h).success(function(){i.processing=!1,i.successMessage="Reset link sent. Check your email."}).error(function(a){i.processing=!1,i.errorMessage=a&&a.message?a.message:"We had trouble sending you a password reset email. Please try again."})},d.is("user.resetpassword")){var l=e.search();h.email=l.email,h.passwordResetCode=l.code,e.search("email",null),e.search("code",null),h.email&&h.passwordResetCode||(i.errorMessage="Reset link error. Please try clicking the link again.")}a.resetPassword=function(){i.processing=!0,b.post("/data/user/reset-password",h).success(function(){i.processing=!1,i.successMessage="login"}).error(function(a){i.processing=!1,i.errorMessage=a&&a.message?a.message:"We had trouble resetting your password. Please try again."})};var m;d.is("user.settings")&&(i.errorMessage=null,i.processing=!0,h=a.user=c("data/user/settings").get(function(){i.processing=!1,m=a.fullUser=angular.copy(h)},function(a){i.processing=!1,i.errorMessage="We had trouble retrieving your settings information. Please try again."})),a.selectNewGroup=function(a){m.group=a;var b=[];a.modules&&a.modules.forEach(function(a){a._id&&b.push(a._id)}),m.group.modules=b,i.editGroup=!1},a.updateSettings=function(){return i.successMessage=null,i.errorMessage=null,m.firstName!==h.firstName&&(j.firstName=m.firstName),m.lastName!==h.lastName&&(j.lastName=m.lastName),m.email!==h.email&&(j.email=m.email),m.newPassword&&!m.password?void(i.errorMessage="Please provide your current password if you want to set a new password."):(m.newPassword&&m.password&&(j.newPassword=m.newPassword,j.password=m.password),!m.group||h.group&&m.group._id===h.group._id||(j.group=m.group),m.facilitator!==h.facilitator&&(j.facilitator=m.facilitator),i.processing=!0,void b.put("/data/user/settings",j).success(function(){i.processing=!1,i.successMessage="Settings Updated",m.newPassword=null,m.password=null,["editFirstName","editLastName","editEmail","editPassword","editGroup","editRole"].forEach(function(a){i[a]=!1})}).error(function(a){i.processing=!1,i.errorMessage=a&&a.message?a.message:"We had trouble updating your settings. Please try again"}))}}]),angular.module("app").controller("WelcomeController",["$scope",function(a){}]);
//# sourceMappingURL=app.min.js.map